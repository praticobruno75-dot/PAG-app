<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Profilo di appartenenza al gruppo</title>
<!-- PWA Manifest -->
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#f5a623">
<link rel="icon" href="./icons/icon-512.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="PAG">
<link rel="apple-touch-icon" href="./icons/icon-512.png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- PDF.js Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // Configura PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  </script>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      background: #3f3f3f;
      color: #f5f5f5;
      margin: 0;
      padding: 24px;
    }
    
    .brand {
      text-align: center;
      margin-bottom: 30px;
      padding-top: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    .brand a {
      color: #ba975c;
      text-decoration: none;
      font-size: 28px;
      font-weight: bold;
      letter-spacing: 2px;
      transition: opacity 0.3s;
    }
    .brand a:hover {
      opacity: 0.8;
    }
    h1 { text-align: center; margin-bottom: 8px; margin-top: 20px; }
    p.subtitle { text-align: center; margin-top: 0; opacity: 0.8; }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    
    .panel {
      background: #2f2f2f;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    
    .field {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      gap: 15px;
    }
    .field label { 
      width: 200px;
      text-align: left;
    }
    .field input {
      width: 200px;
      padding: 8px;
      border-radius: 6px;
      border: none;
    }
    .field select {
      width: auto;
      min-width: 200px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #555;
      background: #3f3f3f;
      color: #f5f5f5;
      font-size: 15px;
      cursor: pointer;
    }
    
    .field input[type="number"] {
      width: 80px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      color: #f5a623;
      background: #1a1a1a;
      border: 2px solid #f5a623;
      padding: 10px;
    }
    
    .values-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }
    
    .category-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin: 20px 0;
    }
    
    .category-btn {
      padding: 20px;
      border: none;
      border-radius: 12px;
      background: #2f2f2f;
      color: #f5f5f5;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .category-btn:hover {
      background: #4f4f4f;
      transform: translateY(-2px);
    }
    
    .category-btn.active {
      background: #f5a623;
      color: #000;
    }
    
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: #f5a623;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      margin-right: 10px;
      margin-top: 10px;
    }
    
    button:hover { background: #ffb84d; }
    
    button.secondary {
      background: #555;
      color: #f5f5f5;
    }
    
    button.secondary:hover {
      background: #666;
    }
    
    .profile-list {
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
      padding-right: 5px;
    }
    
    .profile-list::-webkit-scrollbar {
      width: 8px;
    }
    
    .profile-list::-webkit-scrollbar-track {
      background: #2f2f2f;
      border-radius: 4px;
    }
    
    .profile-list::-webkit-scrollbar-thumb {
      background: #f5a623;
      border-radius: 4px;
    }
    
    .profile-list::-webkit-scrollbar-thumb:hover {
      background: #ffb84d;
    }
    
    .profile-item {
      background: #3f3f3f;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .profile-info {
      flex: 1;
    }
    
    .profile-info strong {
      display: block;
      margin-bottom: 4px;
    }
    
    .profile-info small {
      opacity: 0.7;
    }
    
    .profile-actions button {
      margin: 0 5px;
    }
    
    .chart-container {
      position: relative;
      height: 400px;
      margin: 20px 0;
    }
    
    .hidden {
      display: none;
    }
    
    .mini-chart-container {
      background: #3f3f3f;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    
    .mini-chart-container canvas {
      max-width: 100%;
      height: 200px !important;
    }
    
    .mini-chart-date {
      margin-top: 10px;
      font-weight: bold;
      color: #f5a623;
    }
    
    .mini-chart-desc {
      font-size: 14px;
      opacity: 0.8;
      margin-top: 5px;
    }
    
    /* Carosello mobile */
    .carousel-container {
      position: relative;
      overflow: hidden;
      width: 100%;
    }
    
    .carousel-track {
      display: flex;
      transition: transform 0.3s ease;
    }
    
    .carousel-item {
      min-width: 100%;
      flex-shrink: 0;
    }
    
    .carousel-nav {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
    }
    
    .carousel-btn {
      background: #555;
      color: #f5f5f5;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .carousel-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    .carousel-indicator {
      color: #f5a623;
      font-size: 14px;
      display: flex;
      align-items: center;
    }
    
    .disclaimer {
      background: #2a2a2a;
      border: 2px solid #ff6b6b;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
    }
    
    .disclaimer-title {
      color: #ff6b6b;
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 12px;
    }
    
    .disclaimer-text {
      line-height: 1.6;
      font-size: 15px;
    }
    
    .spp-button {
      width: 100%;
      padding: 15px;
      background: #2f2f2f;
      border: 2px solid #f5a623;
      border-radius: 12px;
      color: #f5a623;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 15px;
    }
    
    .spp-button:hover {
      background: #f5a623;
      color: #000;
    }
    
    .reminder-box {
      background: #2f2f2f;
      border-left: 4px solid #f5a623;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    
    .reminder-category {
      font-weight: bold;
      color: #f5a623;
      margin-bottom: 5px;
    }
    
    .reminder-text {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .notes-area {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #555;
      background: #3f3f3f;
      color: #f5f5f5;
      font-family: Arial, sans-serif;
      font-size: 14px;
      resize: vertical;
      margin-top: 10px;
      box-sizing: border-box;
    }
    
    .appointment-item {
      background: #3f3f3f;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .appointment-input {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr auto;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .appointment-input input {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #555;
      background: #3f3f3f;
      color: #f5f5f5;
    }
    
    .spp-select {
      width: auto;
      min-width: 200px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #555;
      background: #3f3f3f;
      color: #f5f5f5;
      font-size: 15px;
      cursor: pointer;
    }
    
    .spp-select:focus {
      outline: none;
      border-color: #f5a623;
    }
    
    .pdf-viewer {
      width: 100%;
      height: 600px;
      border: 2px solid #555;
      border-radius: 8px;
      background: #3f3f3f;
      margin-top: 20px;
    }
    
    /* RESPONSIVE MOBILE */
    @media (max-width: 900px) {
      body {
        padding: 16px;
        box-sizing: border-box;
      }
      
      .container {
        max-width: 100%;
        padding: 0;
        margin: 0;
      }
      
      .panel {
        padding: 15px;
        margin-left: 0;
        margin-right: 0;
        width: 100%;
        box-sizing: border-box;
      }
      
      .field {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      
      .values-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
      
      .values-grid .field {
        gap: 5px;
      }
      
      .values-grid .field label {
        font-size: 14px;
      }
      
      .field label {
        width: 100%;
        text-align: left;
      }
      
      .field input,
      .field select {
        width: 100% !important;
        max-width: 100%;
        min-width: 0;
      }
      
      .field input[type="number"] {
        width: 100% !important;
        text-align: center;
      }
      
      .category-buttons {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .category-btn {
        padding: 15px;
        font-size: 16px;
      }
      
      button {
        width: 100%;
        padding: 14px;
        font-size: 15px;
      }
      
      /* Appuntamenti responsive */
      .appointment-input {
        grid-template-columns: 1fr;
        gap: 8px;
      }
      
      .appointment-input input {
        width: 100%;
      }
      
      .appointment-input div {
        width: 100%;
      }
      
      .appointment-input select {
        width: 100% !important;
        flex: 1 !important;
      }
      
      .appointment-input button {
        width: 100%;
        padding: 12px;
      }
      
      /* Pulsanti actions panel - uno per riga */
      #actionsPanel {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      
      #actionsPanel button {
        width: 100%;
        margin: 0;
      }
      
      /* Profile item responsive */
      .profile-item {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        padding: 12px;
      }
      
      .profile-info {
        width: 100%;
      }
      
      .profile-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%;
      }
      
      .profile-actions button {
        width: 100%;
        margin: 0;
        padding: 10px;
        font-size: 14px;
      }
      
      .notes-area {
        min-height: 120px;
        width: 100%;
        box-sizing: border-box;
      }
      
      textarea {
        width: 100% !important;
        box-sizing: border-box;
      }
      
      input[type="text"],
      input[type="date"],
      input[type="time"],
      input[type="number"] {
        width: 100% !important;
        box-sizing: border-box;
      }
      
      h1 {
        font-size: 24px;
      }
      
      h2 {
        font-size: 20px;
      }
      
      .brand a {
        font-size: 20px;
      }
      
      /* Timeline charts responsive - Carosello */
      #timelineCharts {
        display: block !important;
        grid-template-columns: unset !important;
      }
      
      .carousel-container {
        display: block;
      }
      
      canvas {
        max-width: 100%;
        height: auto !important;
      }
    }
    
    /* Supporto rotazione schermo */
    @media screen and (orientation: landscape) {
      body {
        padding: 12px;
      }
      .panel {
        margin-bottom: 15px;
      }
    }
    
    /* Forza rotazione per PWA */
    html {
      width: 100vw;
      height: 100vh;
      overflow: auto;
    }
  </style>
</head>
<body>

<!-- HOME SCREEN -->
<div id="homeScreen" class="container">
  <div class="brand">
    <a href="./index.html" style="color: #f5a623; text-decoration: none;">‚¨ÖÔ∏è Menu</a>
    <a href="https://www.fullylife.solutions" target="_blank">FULLYLIFE SOLUTIONS</a>
  </div>
  <h1>Profilo di Appartenenza al Gruppo</h1>
  <p class="subtitle">Lettura delle dinamiche di gruppo</p>
  
  <div class="panel">
    <div class="field">
      <label><strong>Il tuo nome:</strong></label>
      <input id="userName" type="text" placeholder="Inserisci il tuo nome">
    </div>
    <button class="spp-button" onclick="goToSPP()">üìã Struttura Psicofisiologica Primaria</button>
  </div>
  
  <div class="disclaimer">
    <div class="disclaimer-title">‚ö†Ô∏è Nota importante</div>
    <div class="disclaimer-text">
      Questo strumento √® stato progettato per favorire la riflessione personale sulle dinamiche di gruppo e non sostituisce in alcun modo la valutazione, la consulenza o il supporto di un professionista qualificato.<br><br>
      Le letture generate sono indicative e hanno finalit√† esclusivamente di auto-osservazione. L'utilizzo di questo strumento √® riservato a chi sta seguendo o ha completato un percorso Fullylife.<br><br>
      Per un'analisi approfondita della tua situazione, ti invitiamo a consultare il tuo consulente Fullylife di riferimento.
    </div>
  </div>
  
  <div class="panel">
    <h2>Promemoria Aggiornamenti</h2>
    <div id="remindersList"></div>
  </div>
  
  <div class="panel">
    <h2>Note / Promemoria</h2>
    <textarea id="userNotes" class="notes-area" placeholder="Scrivi qui le tue note personali..." onchange="saveUserInfo()"></textarea>
  </div>
  
  <div class="panel">
    <h2>Prossimi Appuntamenti</h2>
    <div class="appointment-input">
      <input id="newAppDescription" type="text" placeholder="Descrizione appuntamento">
      <input id="newAppDate" type="date">
      <div style="display: flex; gap: 8px;">
        <select id="newAppTimeHour" style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #555; background: #3f3f3f; color: #f5f5f5;">
          <option value="">Ora</option>
        </select>
        <select id="newAppTimeMinute" style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #555; background: #3f3f3f; color: #f5f5f5;">
          <option value="">Min</option>
        </select>
      </div>
      <button onclick="addAppointment()">‚ûï</button>
    </div>
    <div id="appointmentsList"></div>
  </div>
  
  <div class="panel">
    <h2 style="text-align: center; margin-bottom: 20px;">Seleziona una categoria</h2>
    <div class="category-buttons">
      <button class="category-btn" onclick="selectCategory('lavoro')">üíº Lavoro</button>
      <button class="category-btn" onclick="selectCategory('famiglia')">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Famiglia</button>
      <button class="category-btn" onclick="selectCategory('altro')">‚ú® Altro</button>
    </div>
  </div>
</div>

<!-- SPP SCREEN -->
<div id="sppScreen" class="container hidden">
  <div class="brand">
    <a href="https://www.fullylife.solutions" target="_blank">FULLYLIFE SOLUTIONS</a>
  </div>
  <button class="secondary" onclick="backToHomeFromSPP()">‚Üê Torna alla home</button>
  
  <h1>üìã Struttura Psicofisiologica Primaria</h1>
  <p class="subtitle">Seleziona le tue caratteristiche per visualizzare le spiegazioni</p>
  
  <div class="panel">
    <h2>Parametri</h2>
    
    <div class="field">
      <label><strong>1. Sessualit√†:</strong></label>
      <select id="sppSessualita" class="spp-select" onchange="updateSPPDisplay()">
        <option value="">-- Seleziona --</option>
        <option value="maschio">Maschio</option>
        <option value="femmina">Femmina</option>
      </select>
    </div>
    
    <div class="field">
      <label><strong>2. Lateralit√†:</strong></label>
      <select id="sppLateralita" class="spp-select" onchange="updateSPPDisplay()">
        <option value="">-- Seleziona --</option>
        <option value="destrimane">Destrimane</option>
        <option value="mancino">Mancino</option>
      </select>
    </div>
    
    <div class="field">
      <label><strong>3. Bisogni:</strong></label>
      <select id="sppBisogni" class="spp-select" onchange="updateSPPDisplay()">
        <option value="">-- Seleziona --</option>
        <option value="protezione">Protezione</option>
        <option value="identificazione">Identificazione</option>
        <option value="spazialita">Spazialit√†</option>
      </select>
    </div>
    
    <div class="field">
      <label><strong>4. Foglietto:</strong></label>
      <select id="sppFoglietto" class="spp-select" onchange="updateSPPDisplay()">
        <option value="">-- Seleziona --</option>
        <option value="boccone">Boccone</option>
        <option value="attacco">Attacco</option>
        <option value="gratificazione">Gratificazione</option>
        <option value="socialita">Socialit√†</option>
      </select>
    </div>
    
    <div class="field">
      <label><strong>5. Intensit√†:</strong></label>
      <select id="sppIntensita" class="spp-select" onchange="updateSPPDisplay()">
        <option value="">-- Seleziona --</option>
        <option value="attivazione">Attivazione</option>
        <option value="inibizione">Inibizione</option>
      </select>
    </div>
    
    <button onclick="saveSPP()">üíæ Salva la mia struttura</button>
  </div>
  
  <div class="panel" id="sppPdfContainer" style="display: none;">
    <h2>Spiegazioni delle caratteristiche selezionate</h2>
    <div id="sppPdfViewer"></div>
  </div>
</div>

<!-- CATEGORY SCREEN -->
<div id="categoryScreen" class="container hidden">
  <div class="brand">
    <a href="https://www.fullylife.solutions" target="_blank">FULLYLIFE SOLUTIONS</a>
  </div>
  <button class="secondary" onclick="backToHome()">‚Üê Torna alla home</button>
  
  <h1 id="categoryTitle"></h1>
  
  <div class="panel" id="timelinePanel" style="display: none;">
    <h2>Evoluzione temporale (ultimi 6 profili)</h2>
    <div style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 8px; font-weight: bold;">Filtra per descrizione:</label>
      <select id="timelineFilter" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #555; background: #3f3f3f; color: #f5f5f5;" onchange="loadTimelineCharts()">
        <option value="">Tutti i profili</option>
      </select>
    </div>
    <div id="timelineCharts" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px;"></div>
  </div>
  
  <div class="panel">
    <h2>I tuoi profili</h2>
    <button onclick="showNewProfileForm()">+ Crea nuovo profilo</button>
    <div id="profileList" class="profile-list"></div>
  </div>
</div>

<!-- PROFILE SCREEN -->
<div id="profileScreen" class="container hidden">
  <div class="brand">
    <a href="https://www.fullylife.solutions" target="_blank">FULLYLIFE SOLUTIONS</a>
  </div>
  <button class="secondary" onclick="backToCategory()">‚Üê Torna ai profili</button>
  
  <div class="panel">
    <h2 id="profileFormTitle">Nuovo Profilo</h2>
    <div class="field">
      <label>Descrizione gruppo:</label>
      <input id="profileDescription" type="text" placeholder="Es: Team Marketing">
    </div>
    <div class="field">
      <label>Data:</label>
      <input id="profileDate" type="date">
    </div>
  </div>
  
  <div class="panel" id="valuesPanel">
    <h2>Inserisci i valori (0‚Äì100)</h2>
    <div class="values-grid">
      <div class="field"><label>Priorit√†</label><input id="priorita" type="number" value="50" min="0" max="100" onfocus="this.select()"></div>
      <div class="field"><label>Intensit√†</label><input id="intensita" type="number" value="50" min="0" max="100" onfocus="this.select()"></div>
      <div class="field"><label>Riconoscimento</label><input id="riconoscimento" type="number" value="50" min="0" max="100" onfocus="this.select()"></div>
      <div class="field"><label>Richieste</label><input id="richieste" type="number" value="50" min="0" max="100" onfocus="this.select()"></div>
      <div class="field"><label>Contributi</label><input id="contributi" type="number" value="50" min="0" max="100" onfocus="this.select()"></div>
      <div class="field"><label>Soddisfazione</label><input id="soddisfazione" type="number" value="50" min="0" max="100" onfocus="this.select()"></div>
    </div>
    <button onclick="updateChart()">Aggiorna visualizzazione</button>
  </div>
  
  <div class="panel">
    <div class="chart-container">
      <canvas id="radarChart"></canvas>
    </div>
  </div>
  
  <div class="panel">
    <h2>Considerazioni</h2>
    <textarea id="profileConsiderations" class="notes-area" placeholder="Inserisci qui le tue considerazioni personali su questo profilo..."></textarea>
  </div>
  
  <div class="panel" id="actionsPanel">
    <button onclick="saveProfile()">üíæ Salva profilo</button>
    <button onclick="showCopyModal()">üìã Copia per WhatsApp</button>
    <button onclick="exportProfile()">üíæ Scarica JSON</button>
    <button class="secondary" onclick="deleteCurrentProfile()">üóëÔ∏è Elimina profilo</button>
  </div>
  
  <div class="panel">
    <details>
      <summary><strong>Come leggere questo strumento</strong></summary>
      <div style="margin-top:12px; line-height:1.6">
        <p><strong>Principio guida fondamentale</strong><br>
        La forma viene prima del valore. I numeri servono solo a generare una configurazione relazionale. La lettura non riguarda quanto una dimensione √® alta o bassa, ma come le dimensioni stanno tra loro.</p>

        <p><strong>Lettura dell'armonia della forma</strong><br>
        ‚Ä¢ <em>Forma armonica</em>: lati relativamente simili, assenza di picchi evidenti. Indica una relazione coerente e stabile ‚Üí lavorare su consapevolezza, consolidamento ed evoluzione intenzionale.<br>
        ‚Ä¢ <em>Forma disarmonica</em>: presenza di picchi o rientranze marcate. Indica una tensione relazionale attiva ‚Üí osservare cosa sostiene cosa nella configurazione.<br>
        ‚Ä¢ <em>Forma polarizzata</em>: poche dimensioni molto alte e altre molto basse. Indica una relazione sostenuta da leve dominanti ‚Üí ridurre la forzatura e la dipendenza da singoli fattori.</p>

        <p><strong>Lettura dell'attivazione complessiva</strong><br>
        Per <em>attivazione</em> si intende il livello di energia relazionale effettivamente messa in gioco nel rapporto con il gruppo, indipendentemente dal fatto che sia una scelta personale o una necessit√† indotta dal sistema.<br><br>
        ‚Ä¢ <em>Attivazione alta</em>: forte coinvolgimento ed esposizione ‚Üí lavorare su confini, sostenibilit√† e riconoscimento dell'energia investita; evitare ulteriori spinte.<br>
        ‚Ä¢ <em>Attivazione media</em>: buona modulabilit√† della relazione ‚Üí piccoli aggiustamenti producono effetti significativi; favorire allineamento e chiarificazione delle priorit√†.<br>
        ‚Ä¢ <em>Attivazione bassa</em>: investimento prudente o difensivo ‚Üí non forzare l'aumento; lavorare su sicurezza psicologica, senso della relazione e priorit√† (scelta vs necessit√†).</p>

        <p><strong>Uso combinato: forma + attivazione</strong><br>
        La lettura emerge sempre dall'incrocio tra configurazione geometrica e livello di attivazione, non dal singolo valore. Due forme simili possono avere significati opposti in base all'attivazione.</p>

        <p><strong>Cosa non fare con questo strumento</strong><br>
        Non confrontare persone tra loro. Non cercare la forma "giusta". Non usare i numeri come giudizio. Non intervenire automaticamente sul valore pi√π basso.</p>

        <p><strong>Nota conclusiva</strong><br>
        La geometria non dice cosa fare: rende visibile ci√≤ che sta accadendo. Il cambiamento nasce dalla conversazione che la forma rende possibile.</p>
      </div>
    </details>
  </div>
</div>

<script>
let currentCategory = '';
let currentProfileId = null;
let radarChart = null;
let isViewMode = false;

const state = {
  userName: '',
  userNotes: '',
  appointments: [],
  spp: {
    sessualita: '',
    lateralita: '',
    bisogni: '',
    foglietto: '',
    intensita: ''
  },
  profiles: {
    lavoro: [],
    famiglia: [],
    altro: []
  }
};

function loadState() {
  const saved = localStorage.getItem('pagState');
  if (saved) {
    const loaded = JSON.parse(saved);
    state.userName = loaded.userName || '';
    state.userNotes = loaded.userNotes || '';
    state.appointments = loaded.appointments || [];
    state.spp = loaded.spp || { sessualita: '', lateralita: '', bisogni: '', foglietto: '', intensita: '' };
    state.profiles = loaded.profiles || { lavoro: [], famiglia: [], altro: [] };
    
    const userNameInput = document.getElementById('userName');
    const userNotesInput = document.getElementById('userNotes');
    
    if (userNameInput) userNameInput.value = state.userName;
    if (userNotesInput) userNotesInput.value = state.userNotes;
  }
  loadReminders();
  loadAppointmentsList();
}

function saveState() {
  const userNameInput = document.getElementById('userName');
  if (userNameInput) state.userName = userNameInput.value;
  localStorage.setItem('pagState', JSON.stringify(state));
}

function saveUserInfo() {
  const userNameInput = document.getElementById('userName');
  const userNotesInput = document.getElementById('userNotes');
  
  if (userNameInput) state.userName = userNameInput.value;
  if (userNotesInput) state.userNotes = userNotesInput.value;
  
  saveState();
}

// SPP Functions
function goToSPP() {
  saveUserInfo();
  document.getElementById('homeScreen').classList.add('hidden');
  document.getElementById('categoryScreen').classList.add('hidden');
  document.getElementById('profileScreen').classList.add('hidden');
  document.getElementById('sppScreen').classList.remove('hidden');
  
  // Carica valori salvati
  document.getElementById('sppSessualita').value = state.spp.sessualita || '';
  document.getElementById('sppLateralita').value = state.spp.lateralita || '';
  document.getElementById('sppBisogni').value = state.spp.bisogni || '';
  document.getElementById('sppFoglietto').value = state.spp.foglietto || '';
  document.getElementById('sppIntensita').value = state.spp.intensita || '';
  
  updateSPPDisplay();
}

function backToHomeFromSPP() {
  document.getElementById('sppScreen').classList.add('hidden');
  document.getElementById('homeScreen').classList.remove('hidden');
  loadReminders();
  loadAppointmentsList();
}

function updateSPPDisplay() {
  const sessualita = document.getElementById('sppSessualita').value;
  const lateralita = document.getElementById('sppLateralita').value;
  const bisogni = document.getElementById('sppBisogni').value;
  const foglietto = document.getElementById('sppFoglietto').value;
  const intensita = document.getElementById('sppIntensita').value;
  
  if (sessualita || lateralita || bisogni || foglietto || intensita) {
    document.getElementById('sppPdfContainer').style.display = 'block';
    
    let displayText = '<div style="padding: 20px; line-height: 1.8;">';
    displayText += '<p style="color: #f5a623; font-weight: bold; margin-bottom: 15px;">Hai selezionato:</p>';
    
    if (sessualita) displayText += `<p>‚Ä¢ <strong>Sessualit√†:</strong> ${sessualita.charAt(0).toUpperCase() + sessualita.slice(1)}</p>`;
    if (lateralita) displayText += `<p>‚Ä¢ <strong>Lateralit√†:</strong> ${lateralita.charAt(0).toUpperCase() + lateralita.slice(1)}</p>`;
    if (bisogni) displayText += `<p>‚Ä¢ <strong>Bisogni:</strong> ${bisogni.charAt(0).toUpperCase() + bisogni.slice(1)}</p>`;
    if (foglietto) displayText += `<p>‚Ä¢ <strong>Foglietto:</strong> ${foglietto.charAt(0).toUpperCase() + foglietto.slice(1)}</p>`;
    if (intensita) displayText += `<p>‚Ä¢ <strong>Intensit√†:</strong> ${intensita.charAt(0).toUpperCase() + intensita.slice(1)}</p>`;
    
    // Mappa PDF in base alla selezione
    const pdfList = [];
    
    // Sessualit√†
    if (sessualita === 'maschio') {
      pdfList.push({nome: 'MASCHIO.pdf', titolo: 'Maschio'});
      if (lateralita === 'destrimane') pdfList.push({nome: 'MASCHIO_DX.pdf', titolo: 'Maschio Destrimane'});
      if (lateralita === 'mancino') pdfList.push({nome: 'MASCHIO_SX.pdf', titolo: 'Maschio Mancino'});
    } else if (sessualita === 'femmina') {
      pdfList.push({nome: 'FEMMINA.pdf', titolo: 'Femmina'});
      if (lateralita === 'destrimane') pdfList.push({nome: 'FEMMINA_DX.pdf', titolo: 'Femmina Destrimane'});
      if (lateralita === 'mancino') pdfList.push({nome: 'FEMMINA_SX.pdf', titolo: 'Femmina Mancina'});
    }
    
    // Interazione di genere
    if (sessualita) {
      pdfList.push({nome: 'INTERAZIONE_GENERE.pdf', titolo: 'Interazione Relazionale di Genere'});
    }
    
    // Bisogni
    if (bisogni === 'protezione') pdfList.push({nome: 'PROTEZIONE.pdf', titolo: 'Protezione'});
    if (bisogni === 'identificazione') pdfList.push({nome: 'IDENTIFICAZIONE.pdf', titolo: 'Identificazione'});
    if (bisogni === 'spazialita') pdfList.push({nome: 'SPAZIALITA_.pdf', titolo: 'Spazialit√†'});
    
    // Foglietto
    if (foglietto === 'boccone') pdfList.push({nome: 'BOCCONE.pdf', titolo: 'Boccone'});
    if (foglietto === 'attacco') pdfList.push({nome: 'ATTACCO.pdf', titolo: 'Attacco'});
    if (foglietto === 'gratificazione') pdfList.push({nome: 'GRATIFICAZIONE.pdf', titolo: 'Gratificazione'});
    if (foglietto === 'socialita') pdfList.push({nome: 'SOCIALITA_.pdf', titolo: 'Socialit√†'});
    
    // Intensit√†
    if (intensita === 'attivazione') pdfList.push({nome: 'ATTIVAZIONE.pdf', titolo: 'Attivazione'});
    if (intensita === 'inibizione') pdfList.push({nome: 'INIBIZIONE.pdf', titolo: 'Inibizione'});
    
    // Mostra PDF
    if (pdfList.length > 0) {
      displayText += '<div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #f5a623;">';
      displayText += '<p style="color: #f5a623; font-weight: bold; margin-bottom: 8px;">üìÑ Documenti PDF di Approfondimento:</p>';
      displayText += '<p style="font-size: 13px; opacity: 0.8; margin-bottom: 15px;">üí° Clicca per visualizzare il PDF</p>';
      
      pdfList.forEach(pdf => {
        displayText += `
          <div style="margin: 10px 0; padding: 12px; background: #2a2a2a; border-radius: 6px; border-left: 3px solid #f5a623; cursor: pointer;"
               onclick="openPDFViewer('./pdf/${pdf.nome}', '${pdf.titolo}')">
            <div style="color: #f5f5f5; text-decoration: none; display: flex; align-items: center; justify-content: space-between; gap: 10px;">
              <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 24px;">üìï</span>
                <span style="font-weight: bold;">${pdf.titolo}</span>
              </div>
              <span style="font-size: 20px; opacity: 0.6;">üëÅÔ∏è</span>
            </div>
          </div>`;
      });
      
      displayText += '</div>';
    } else {
      displayText += '<p style="margin-top: 20px; opacity: 0.7; font-style: italic;">Seleziona le caratteristiche per vedere i PDF di approfondimento.</p>';
    }
    
    displayText += '</div>';
    
    document.getElementById('sppPdfViewer').innerHTML = displayText;
  } else {
    document.getElementById('sppPdfContainer').style.display = 'none';
  }
}

// Funzione per mostrare pulsante chiudi PDF
// Visualizzatore PDF personalizzato con PDF.js
let currentPdfDoc = null;
let currentPageNum = 1;
let totalPages = 0;
let pdfScale = 1.5;

function openPDFViewer(pdfPath, pdfTitle) {
  // Crea modal
  const modal = document.createElement('div');
  modal.id = 'pdfModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.95);
    z-index: 100000;
    display: flex;
    flex-direction: column;
  `;
  
  // Header con titolo e pulsante chiudi
  const header = document.createElement('div');
  header.style.cssText = `
    background: #2f2f2f;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid #f5a623;
    flex-shrink: 0;
  `;
  
  header.innerHTML = `
    <div style="display: flex; align-items: center; gap: 15px; flex: 1; min-width: 0;">
      <span style="color: #f5a623; font-weight: bold; font-size: 16px;">üìï</span>
      <span style="color: #f5f5f5; font-weight: bold; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${pdfTitle}</span>
    </div>
    <button id="closePdfBtn" style="
      background: #f5a623;
      color: #1a1a1a;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      font-size: 16px;
      flex-shrink: 0;
    ">‚úï Chiudi</button>
  `;
  
  // Container canvas
  const canvasContainer = document.createElement('div');
  canvasContainer.style.cssText = `
    flex: 1;
    overflow: auto;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 20px;
    background: #1a1a1a;
  `;
  
  const canvas = document.createElement('canvas');
  canvas.id = 'pdfCanvas';
  canvas.style.cssText = `
    max-width: 100%;
    height: auto;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  `;
  canvasContainer.appendChild(canvas);
  
  // Footer con controlli pagina
  const footer = document.createElement('div');
  footer.style.cssText = `
    background: #2f2f2f;
    padding: 15px 20px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    border-top: 2px solid #f5a623;
    flex-shrink: 0;
  `;
  
  footer.innerHTML = `
    <button id="prevPage" style="
      background: #555;
      color: #f5f5f5;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    ">‚Üê Prec</button>
    <span id="pageInfo" style="color: #f5f5f5; font-weight: bold; min-width: 100px; text-align: center;">Pagina 1 / 1</span>
    <button id="nextPage" style="
      background: #555;
      color: #f5f5f5;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    ">Succ ‚Üí</button>
  `;
  
  // Assembla modal
  modal.appendChild(header);
  modal.appendChild(canvasContainer);
  modal.appendChild(footer);
  document.body.appendChild(modal);
  
  // Event listeners
  document.getElementById('closePdfBtn').onclick = () => {
    modal.remove();
    currentPdfDoc = null;
  };
  
  document.getElementById('prevPage').onclick = () => {
    if (currentPageNum > 1) {
      currentPageNum--;
      renderPage(currentPageNum);
    }
  };
  
  document.getElementById('nextPage').onclick = () => {
    if (currentPageNum < totalPages) {
      currentPageNum++;
      renderPage(currentPageNum);
    }
  };
  
  // Carica PDF
  loadPDF(pdfPath);
}

async function loadPDF(pdfPath) {
  try {
    const loadingTask = pdfjsLib.getDocument(pdfPath);
    currentPdfDoc = await loadingTask.promise;
    totalPages = currentPdfDoc.numPages;
    currentPageNum = 1;
    
    document.getElementById('pageInfo').textContent = `Pagina ${currentPageNum} / ${totalPages}`;
    
    renderPage(currentPageNum);
  } catch (error) {
    console.error('Errore caricamento PDF:', error);
    alert('Errore nel caricamento del PDF');
  }
}

async function renderPage(pageNum) {
  try {
    const page = await currentPdfDoc.getPage(pageNum);
    const canvas = document.getElementById('pdfCanvas');
    const context = canvas.getContext('2d');
    
    const viewport = page.getViewport({ scale: pdfScale });
    
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    
    const renderContext = {
      canvasContext: context,
      viewport: viewport
    };
    
    await page.render(renderContext).promise;
    
    document.getElementById('pageInfo').textContent = `Pagina ${pageNum} / ${totalPages}`;
    
    // Abilita/disabilita pulsanti
    document.getElementById('prevPage').disabled = (pageNum === 1);
    document.getElementById('nextPage').disabled = (pageNum === totalPages);
    
  } catch (error) {
    console.error('Errore rendering pagina:', error);
  }
}

function saveSPP() {
  state.spp.sessualita = document.getElementById('sppSessualita').value;
  state.spp.lateralita = document.getElementById('sppLateralita').value;
  state.spp.bisogni = document.getElementById('sppBisogni').value;
  state.spp.foglietto = document.getElementById('sppFoglietto').value;
  state.spp.intensita = document.getElementById('sppIntensita').value;
  
  saveState();
  alert('Struttura Psicofisiologica Primaria salvata!');
}

// Reminder Functions
function formatDate(dateString) {
  const [year, month, day] = dateString.split('-');
  return `${day}-${month}-${year}`;
}

function loadReminders() {
  const remindersList = document.getElementById('remindersList');
  if (!remindersList) return;
  
  const reminders = [];
  const today = new Date();
  const daysSinceThreshold = 30;
  
  ['lavoro', 'famiglia', 'altro'].forEach(category => {
    const profiles = state.profiles[category];
    if (profiles && profiles.length > 0) {
      const sortedProfiles = [...profiles].sort((a, b) => 
        new Date(b.date) - new Date(a.date)
      );
      const lastProfile = sortedProfiles[0];
      const lastDate = new Date(lastProfile.date);
      const daysSince = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
      
      if (daysSince >= daysSinceThreshold) {
        reminders.push({
          category: category,
          daysSince: daysSince,
          lastDate: lastProfile.date
        });
      }
    }
  });
  
  if (reminders.length === 0) {
    remindersList.innerHTML = '<p style="opacity: 0.6; text-align: center;">Tutti i profili sono aggiornati! ‚úì</p>';
    return;
  }
  
  const categoryNames = {
    lavoro: 'üíº Lavoro',
    famiglia: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Famiglia',
    altro: '‚ú® Altro'
  };
  
  remindersList.innerHTML = reminders.map(r => `
    <div class="reminder-box">
      <div class="reminder-category">${categoryNames[r.category]}</div>
      <div class="reminder-text">
        Ultimo profilo creato ${r.daysSince} giorni fa (${formatDate(r.lastDate)})
        <br><strong>Considera di creare un nuovo profilo!</strong>
      </div>
    </div>
  `).join('');
}

function addAppointment() {
  const description = document.getElementById('newAppDescription').value;
  const date = document.getElementById('newAppDate').value;
  const hour = document.getElementById('newAppTimeHour').value;
  const minute = document.getElementById('newAppTimeMinute').value;
  
  if (!description || !date || !hour || !minute) {
    alert('Compila tutti i campi dell\'appuntamento');
    return;
  }
  
  const time = `${hour}:${minute}`;
  
  state.appointments.push({ description, date, time });
  state.appointments.sort((a, b) => {
    const dateA = new Date(a.date + ' ' + a.time);
    const dateB = new Date(b.date + ' ' + b.time);
    return dateA - dateB;
  });
  
  saveState();
  loadAppointmentsList();
  
  document.getElementById('newAppDescription').value = '';
  document.getElementById('newAppDate').value = '';
  document.getElementById('newAppTimeHour').value = '';
  document.getElementById('newAppTimeMinute').value = '';
}

function loadAppointmentsList() {
  const list = document.getElementById('appointmentsList');
  if (!list) return;
  
  if (state.appointments.length === 0) {
    list.innerHTML = '<p style="opacity: 0.6; text-align: center; margin-top: 10px;">Nessun appuntamento</p>';
    return;
  }
  
  list.innerHTML = state.appointments.map((app, index) => `
    <div class="appointment-item">
      <div>
        <strong>${app.description}</strong><br>
        <small>${formatDate(app.date)} ‚Ä¢ ${app.time}</small>
      </div>
      <button class="secondary" onclick="deleteAppointment(${index})">üóëÔ∏è</button>
    </div>
  `).join('');
}

function deleteAppointment(index) {
  if (confirm('Eliminare questo appuntamento?')) {
    state.appointments.splice(index, 1);
    saveState();
    loadAppointmentsList();
  }
}

function selectCategory(category) {
  currentCategory = category;
  saveUserInfo();
  saveState();
  
  document.getElementById('homeScreen').classList.add('hidden');
  document.getElementById('categoryScreen').classList.remove('hidden');
  
  const titles = {
    lavoro: 'üíº Lavoro',
    famiglia: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Famiglia',
    altro: '‚ú® Altro'
  };
  
  document.getElementById('categoryTitle').textContent = titles[category];
  loadProfileList();
  loadTimelineCharts();
}

function backToHome() {
  document.getElementById('categoryScreen').classList.add('hidden');
  document.getElementById('homeScreen').classList.remove('hidden');
  loadReminders();
  loadAppointmentsList();
}

function loadProfileList() {
  const list = document.getElementById('profileList');
  const profiles = state.profiles[currentCategory];
  
  if (profiles.length === 0) {
    list.innerHTML = '<p style="opacity: 0.6; text-align: center; margin-top: 20px;">Nessun profilo creato</p>';
    return;
  }
  
  list.innerHTML = profiles.map((profile, index) => `
    <div class="profile-item">
      <div class="profile-info">
        <strong>${profile.description}</strong>
        <small>${formatDate(profile.date)}</small>
      </div>
      <div class="profile-actions">
        <button onclick="viewProfile(${index})">üëÅÔ∏è Visualizza</button>
        <button onclick="exportProfileById(${index})">üì§ Esporta</button>
        <button class="secondary" onclick="deleteProfile(${index})">üóëÔ∏è</button>
      </div>
    </div>
  `).join('');
}

function loadTimelineCharts() {
  const profiles = state.profiles[currentCategory];
  const timelinePanel = document.getElementById('timelinePanel');
  const timelineCharts = document.getElementById('timelineCharts');
  const timelineFilter = document.getElementById('timelineFilter');
  
  if (profiles.length === 0) {
    timelinePanel.style.display = 'none';
    return;
  }
  
  timelinePanel.style.display = 'block';
  
  // Popola il filtro con le descrizioni uniche
  const uniqueDescriptions = [...new Set(profiles.map(p => p.description))];
  const currentFilter = timelineFilter.value;
  
  timelineFilter.innerHTML = '<option value="">Tutti i profili</option>';
  uniqueDescriptions.forEach(desc => {
    const option = document.createElement('option');
    option.value = desc;
    option.textContent = desc;
    if (desc === currentFilter) option.selected = true;
    timelineFilter.appendChild(option);
  });
  
  // Filtra i profili per descrizione se selezionata
  let filteredProfiles = profiles;
  if (currentFilter) {
    filteredProfiles = profiles.filter(p => p.description === currentFilter);
  }
  
  // Ordina e prendi ultimi 6
  const sortedProfiles = [...filteredProfiles].sort((a, b) => 
    new Date(b.date) - new Date(a.date)
  ).slice(0, 6);
  
  if (sortedProfiles.length === 0) {
    timelineCharts.innerHTML = '<p style="text-align: center; opacity: 0.6; margin: 20px;">Nessun profilo per questa descrizione</p>';
    return;
  }
  
  const profilesToShow = sortedProfiles.reverse();
  
  // Rileva se √® mobile
  const isMobile = window.innerWidth <= 768;
  
  if (isMobile) {
    // CAROSELLO MOBILE
    timelineCharts.innerHTML = `
      <div class="carousel-container">
        <div class="carousel-track" id="carouselTrack"></div>
      </div>
      <div class="carousel-nav">
        <button class="carousel-btn" id="prevBtn" onclick="moveCarousel(-1)">‚Äπ</button>
        <div class="carousel-indicator">
          <span id="currentSlide">1</span> / <span id="totalSlides">${profilesToShow.length}</span>
        </div>
        <button class="carousel-btn" id="nextBtn" onclick="moveCarousel(1)">‚Ä∫</button>
      </div>
    `;
    
    const track = document.getElementById('carouselTrack');
    
    profilesToShow.forEach((profile, index) => {
      const chartId = `miniChart${index}`;
      const item = document.createElement('div');
      item.className = 'carousel-item';
      item.innerHTML = `
        <div class="mini-chart-container">
          <canvas id="${chartId}"></canvas>
          <div class="mini-chart-date">${formatDate(profile.date)}</div>
          <div class="mini-chart-desc">${profile.description}</div>
        </div>
      `;
      track.appendChild(item);
      
      setTimeout(() => createMiniChart(chartId, profile.values), 50);
    });
    
    // Inizializza carosello
    window.currentCarouselIndex = 0;
    updateCarouselButtons();
    
  } else {
    // GRIGLIA DESKTOP
    timelineCharts.innerHTML = '';
    
    profilesToShow.forEach((profile, index) => {
      const chartId = `miniChart${index}`;
      const container = document.createElement('div');
      container.className = 'mini-chart-container';
      container.innerHTML = `
        <canvas id="${chartId}"></canvas>
        <div class="mini-chart-date">${formatDate(profile.date)}</div>
        <div class="mini-chart-desc">${profile.description}</div>
      `;
      timelineCharts.appendChild(container);
      
      setTimeout(() => createMiniChart(chartId, profile.values), 50);
    });
  }
}

function createMiniChart(chartId, values) {
  const ctx = document.getElementById(chartId);
  if (ctx) {
    new Chart(ctx, {
      type: 'radar',
      data: {
        labels: ['Priorit√†','Intensit√†','Riconosc.','Richieste','Contributi','Soddisfaz.'],
        datasets: [{
          data: values,
          fill: true,
          backgroundColor: 'rgba(245,166,35,0.4)',
          borderColor: 'rgba(245,166,35,1)',
          borderWidth: 2,
          pointBackgroundColor: 'rgba(245,166,35,1)',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointRadius: 4,
          pointHoverRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { 
          r: { 
            min: 0, 
            max: 100,
            ticks: { 
              display: true,
              stepSize: 50,
              color: '#f5f5f5',
              backdropColor: 'transparent',
              font: { size: 10 }
            },
            grid: {
              color: 'rgba(255, 255, 255, 0.2)',
              lineWidth: 1.5
            },
            angleLines: {
              color: 'rgba(255, 255, 255, 0.2)',
              lineWidth: 1.5
            },
            pointLabels: { 
              font: { 
                size: 11,
                weight: 'bold'
              },
              color: '#f5a623'
            }
          } 
        },
        plugins: { 
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(47, 47, 47, 0.9)',
            titleColor: '#f5a623',
            bodyColor: '#f5f5f5',
            borderColor: '#f5a623',
            borderWidth: 1,
            padding: 8,
            displayColors: false
          }
        }
      }
    });
  }
}

// Funzioni carosello
function moveCarousel(direction) {
  const track = document.getElementById('carouselTrack');
  const totalSlides = track.children.length;
  
  window.currentCarouselIndex = (window.currentCarouselIndex || 0) + direction;
  
  if (window.currentCarouselIndex < 0) {
    window.currentCarouselIndex = 0;
  } else if (window.currentCarouselIndex >= totalSlides) {
    window.currentCarouselIndex = totalSlides - 1;
  }
  
  track.style.transform = `translateX(-${window.currentCarouselIndex * 100}%)`;
  updateCarouselButtons();
}

function updateCarouselButtons() {
  const track = document.getElementById('carouselTrack');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const currentSlide = document.getElementById('currentSlide');
  
  if (!track) return;
  
  const totalSlides = track.children.length;
  const index = window.currentCarouselIndex || 0;
  
  if (prevBtn) prevBtn.disabled = index === 0;
  if (nextBtn) nextBtn.disabled = index === totalSlides - 1;
  if (currentSlide) currentSlide.textContent = index + 1;
}

function showNewProfileForm() {
  currentProfileId = null;
  isViewMode = false;
  document.getElementById('categoryScreen').classList.add('hidden');
  document.getElementById('profileScreen').classList.remove('hidden');
  document.getElementById('profileFormTitle').textContent = 'Nuovo Profilo';
  
  document.getElementById('profileDescription').value = '';
  document.getElementById('profileDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('profileConsiderations').value = '';
  
  document.getElementById('priorita').value = 50;
  document.getElementById('intensita').value = 50;
  document.getElementById('riconoscimento').value = 50;
  document.getElementById('richieste').value = 50;
  document.getElementById('contributi').value = 50;
  document.getElementById('soddisfazione').value = 50;
  
  setEditableMode(true);
  
  initChart();
  updateChart();
  
  // Scroll in alto per vedere la descrizione
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function viewProfile(index) {
  currentProfileId = index;
  isViewMode = true;
  const profile = state.profiles[currentCategory][index];
  
  document.getElementById('categoryScreen').classList.add('hidden');
  document.getElementById('profileScreen').classList.remove('hidden');
  document.getElementById('profileFormTitle').textContent = 'Visualizza Profilo';
  
  document.getElementById('profileDescription').value = profile.description;
  document.getElementById('profileDate').value = profile.date;
  document.getElementById('profileConsiderations').value = profile.considerations || '';
  document.getElementById('priorita').value = profile.values[0];
  document.getElementById('intensita').value = profile.values[1];
  document.getElementById('riconoscimento').value = profile.values[2];
  document.getElementById('richieste').value = profile.values[3];
  document.getElementById('contributi').value = profile.values[4];
  document.getElementById('soddisfazione').value = profile.values[5];
  
  setEditableMode(false);
  
  initChart();
  updateChart();
  
  // Scroll in alto
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function setEditableMode(editable) {
  document.getElementById('profileDescription').disabled = !editable;
  document.getElementById('profileDate').disabled = !editable;
  document.getElementById('profileConsiderations').disabled = !editable;
  document.getElementById('priorita').disabled = !editable;
  document.getElementById('intensita').disabled = !editable;
  document.getElementById('riconoscimento').disabled = !editable;
  document.getElementById('richieste').disabled = !editable;
  document.getElementById('contributi').disabled = !editable;
  document.getElementById('soddisfazione').disabled = !editable;
  
  const updateBtn = document.querySelector('#valuesPanel button');
  const saveBtn = document.querySelector('#actionsPanel button:first-child');
  
  if (editable) {
    if (updateBtn) updateBtn.style.display = 'inline-block';
    if (saveBtn) saveBtn.style.display = 'inline-block';
  } else {
    if (updateBtn) updateBtn.style.display = 'none';
    if (saveBtn) saveBtn.style.display = 'none';
  }
}

function backToCategory() {
  document.getElementById('profileScreen').classList.add('hidden');
  document.getElementById('categoryScreen').classList.remove('hidden');
  currentProfileId = null;
  loadTimelineCharts();
}

function saveProfile() {
  if (isViewMode) {
    alert('Profilo in sola visualizzazione');
    return;
  }
  
  const description = document.getElementById('profileDescription').value;
  const date = document.getElementById('profileDate').value;
  const considerations = document.getElementById('profileConsiderations').value;
  
  if (!description || !date) {
    alert('Inserisci descrizione e data');
    return;
  }
  
  const values = [
    Number(document.getElementById('priorita').value),
    Number(document.getElementById('intensita').value),
    Number(document.getElementById('riconoscimento').value),
    Number(document.getElementById('richieste').value),
    Number(document.getElementById('contributi').value),
    Number(document.getElementById('soddisfazione').value)
  ];
  
  const profile = { description, date, considerations, values };
  
  if (currentProfileId !== null) {
    state.profiles[currentCategory][currentProfileId] = profile;
  } else {
    state.profiles[currentCategory].push(profile);
  }
  
  saveState();
  alert('Profilo salvato!');
  backToCategory();
  
  // Aggiorna lista e timeline immediatamente
  loadProfileList();
  loadTimelineCharts();
  loadReminders();
}

function deleteProfile(index) {
  if (confirm('Sei sicuro di voler eliminare questo profilo?')) {
    state.profiles[currentCategory].splice(index, 1);
    saveState();
    loadProfileList();
    loadTimelineCharts();
    loadReminders();
  }
}

function deleteCurrentProfile() {
  if (currentProfileId !== null) {
    deleteProfile(currentProfileId);
    backToCategory();
  }
}

// Funzione per mostrare il profilo in un modal copiabile
function showCopyModal() {
  const description = document.getElementById('profileDescription').value;
  const date = document.getElementById('profileDate').value;
  const considerations = document.getElementById('profileConsiderations').value;
  
  if (!description || !date) {
    alert('Salva prima il profilo');
    return;
  }
  
  const values = [
    Number(document.getElementById('priorita').value),
    Number(document.getElementById('intensita').value),
    Number(document.getElementById('riconoscimento').value),
    Number(document.getElementById('richieste').value),
    Number(document.getElementById('contributi').value),
    Number(document.getElementById('soddisfazione').value)
  ];
  
  const userName = document.getElementById('userName').value || 'Utente';
  
  const exportData = {
    utente: userName,
    categoria: currentCategory,
    descrizione: description,
    data: date,
    considerazioni: considerations,
    valori: {
      priorita: values[0],
      intensita: values[1],
      riconoscimento: values[2],
      richieste: values[3],
      contributi: values[4],
      soddisfazione: values[5]
    }
  };
  
  const jsonText = JSON.stringify(exportData, null, 2);
  
  // Crea modal
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 20px;
  `;
  
  const content = document.createElement('div');
  content.style.cssText = `
    background: #2f2f2f;
    padding: 20px;
    border-radius: 12px;
    max-width: 500px;
    width: 100%;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
  `;
  
  content.innerHTML = `
    <h2 style="color: #f5a623; margin-bottom: 15px; text-align: center;">üìã Copia questo testo</h2>
    <p style="text-align: center; margin-bottom: 15px; opacity: 0.8; font-size: 14px;">
      Tieni premuto sul testo qui sotto, seleziona tutto e copia
    </p>
    <textarea readonly style="
      width: 100%;
      height: 300px;
      padding: 15px;
      background: #1a1a1a;
      color: #f5f5f5;
      border: 2px solid #555;
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
      resize: none;
      margin-bottom: 15px;
    " id="copyTextArea">${jsonText}</textarea>
    <div style="display: flex; gap: 10px;">
      <button onclick="selectAllText()" style="
        flex: 1;
        padding: 12px;
        background: #f5a623;
        color: #000;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
      ">‚úì Seleziona Tutto</button>
      <button onclick="this.closest('[style*=fixed]').remove()" style="
        flex: 1;
        padding: 12px;
        background: #555;
        color: #f5f5f5;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
      ">‚úï Chiudi</button>
    </div>
    <p style="text-align: center; margin-top: 15px; font-size: 13px; opacity: 0.7;">
      Dopo aver copiato, incolla su WhatsApp
    </p>
  `;
  
  modal.appendChild(content);
  document.body.appendChild(modal);
  
  // Seleziona automaticamente il testo
  setTimeout(() => {
    const textarea = document.getElementById('copyTextArea');
    textarea.focus();
    textarea.select();
  }, 100);
  
  // Chiudi cliccando fuori
  modal.onclick = (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  };
}

function selectAllText() {
  const textarea = document.getElementById('copyTextArea');
  textarea.focus();
  textarea.select();
  
  // Prova anche la copia automatica
  try {
    document.execCommand('copy');
    alert('‚úÖ Testo copiato! Ora incolla su WhatsApp');
  } catch (err) {
    alert('‚úì Testo selezionato! Ora:\n1. Tocca "Copia" dal menu\n2. Apri WhatsApp\n3. Incolla');
  }
}

function exportProfile() {
  const description = document.getElementById('profileDescription').value;
  const date = document.getElementById('profileDate').value;
  const considerations = document.getElementById('profileConsiderations').value;
  
  if (!description || !date) {
    alert('Salva prima il profilo');
    return;
  }
  
  const values = [
    Number(document.getElementById('priorita').value),
    Number(document.getElementById('intensita').value),
    Number(document.getElementById('riconoscimento').value),
    Number(document.getElementById('richieste').value),
    Number(document.getElementById('contributi').value),
    Number(document.getElementById('soddisfazione').value)
  ];
  
  const userName = document.getElementById('userName').value || 'Utente';
  
  const exportData = {
    utente: userName,
    categoria: currentCategory,
    descrizione: description,
    data: date,
    considerazioni: considerations,
    valori: {
      priorita: values[0],
      intensita: values[1],
      riconoscimento: values[2],
      richieste: values[3],
      contributi: values[4],
      soddisfazione: values[5]
    }
  };
  
  const jsonText = JSON.stringify(exportData, null, 2);
  const fileName = `PAG_${userName}_${description}_${date}.json`;
  
  // Download diretto
  const blob = new Blob([jsonText], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = fileName;
  a.click();
  URL.revokeObjectURL(url);
}

async function exportProfileById(index) {
  const profile = state.profiles[currentCategory][index];
  const userName = document.getElementById('userName').value || 'Utente';
  
  const exportData = {
    utente: userName,
    categoria: currentCategory,
    descrizione: profile.description,
    data: profile.date,
    considerazioni: profile.considerations || '',
    valori: {
      priorita: profile.values[0],
      intensita: profile.values[1],
      riconoscimento: profile.values[2],
      richieste: profile.values[3],
      contributi: profile.values[4],
      soddisfazione: profile.values[5]
    }
  };
  
  const jsonText = JSON.stringify(exportData, null, 2);
  const fileName = `PAG_${userName}_${profile.description}_${profile.date}.json`;
  
  // Prova prima con Web Share API (mobile-friendly)
  if (navigator.share && navigator.canShare) {
    try {
      const blob = new Blob([jsonText], { type: 'application/json' });
      const file = new File([blob], fileName, { type: 'application/json' });
      
      // Verifica se pu√≤ condividere file
      if (navigator.canShare({ files: [file] })) {
        await navigator.share({
          title: 'Profilo PAG',
          text: `Profilo PAG - ${profile.description}`,
          files: [file]
        });
        return; // Condivisione riuscita!
      }
    } catch (err) {
      // Se l'utente annulla la condivisione o c'√® un errore, continua con fallback
      if (err.name !== 'AbortError') {
        console.log('Condivisione non riuscita, uso fallback:', err);
      } else {
        return; // Utente ha annullato
      }
    }
  }
  
  // Fallback: download classico (per desktop o browser senza Web Share API)
  const blob = new Blob([jsonText], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = fileName;
  a.click();
  URL.revokeObjectURL(url);
}

function initChart() {
  if (radarChart) {
    radarChart.destroy();
  }
  
  const ctx = document.getElementById('radarChart');
  radarChart = new Chart(ctx, {
    type: 'radar',
    data: {
      labels: ['Priorit√†','Intensit√†','Riconosc.','Richieste','Contributi','Soddisfaz.'],
      datasets: [{
        data: [50,50,50,50,50,50],
        fill: true,
        backgroundColor: 'rgba(245,166,35,0.4)',
        borderColor: 'rgba(245,166,35,1)',
        borderWidth: 3,
        pointBackgroundColor: 'rgba(245,166,35,1)',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 5,
        pointHoverRadius: 7
      }]
    },
    options: {
      scales: { 
        r: { 
          min: 0, 
          max: 100,
          ticks: { 
            display: true,
            stepSize: 20,
            color: '#f5f5f5',
            backdropColor: 'transparent',
            font: { size: 12 }
          },
          grid: {
            color: 'rgba(255, 255, 255, 0.2)',
            lineWidth: 2
          },
          angleLines: {
            color: 'rgba(255, 255, 255, 0.2)',
            lineWidth: 2
          },
          pointLabels: {
            font: { 
              size: 14,
              weight: 'bold'
            },
            color: '#f5a623'
          }
        } 
      },
      plugins: { 
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(47, 47, 47, 0.9)',
          titleColor: '#f5a623',
          bodyColor: '#f5f5f5',
          borderColor: '#f5a623',
          borderWidth: 1,
          padding: 12,
          displayColors: false
        }
      }
    }
  });
}

function updateChart() {
  const values = [
    Number(document.getElementById('priorita').value),
    Number(document.getElementById('intensita').value),
    Number(document.getElementById('riconoscimento').value),
    Number(document.getElementById('richieste').value),
    Number(document.getElementById('contributi').value),
    Number(document.getElementById('soddisfazione').value)
  ];
  
  radarChart.data.datasets[0].data = values;
  radarChart.update();
}

loadState();

// Popola select ore e minuti
function populateTimeSelects() {
  const hourSelect = document.getElementById('newAppTimeHour');
  const minuteSelect = document.getElementById('newAppTimeMinute');
  
  if (!hourSelect || !minuteSelect) return;
  
  for (let h = 0; h < 24; h++) {
    const opt = document.createElement('option');
    opt.value = h.toString().padStart(2, '0');
    opt.textContent = h.toString().padStart(2, '0');
    hourSelect.appendChild(opt);
  }
  
  for (let m = 0; m < 60; m += 5) {
    const opt = document.createElement('option');
    opt.value = m.toString().padStart(2, '0');
    opt.textContent = m.toString().padStart(2, '0');
    minuteSelect.appendChild(opt);
  }
}

// Chiama subito
populateTimeSelects();
</script>

<!-- Service Worker Registration -->
<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js")
      .then(reg => console.log("‚úÖ SW registered"))
      .catch(err => console.log("‚ùå SW registration failed:", err));
  });
}
</script>
</body>
</html>